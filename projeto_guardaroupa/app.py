import streamlit as st
import pandas as pd
from pathlib import Path
import sys
import base64 

# Garante que o motor de recomenda√ß√£o (backend) possa ser importado
# Assumimos que 'motor_recomendacao.py' est√° no mesmo diret√≥rio
sys.path.append(str(Path(__file__).resolve().parent))

# Importa o cora√ß√£o da IA
from motor_recomendacao import recomendar_looks

# --- Configura√ß√£o Inicial ---
st.set_page_config(page_title="IA Guarda-Roupa", page_icon="üëó", layout="wide")
st.title("üß† IA Guarda-Roupa: Seu Estilista Pessoal")

# --- Vari√°veis de Estado (Simula√ß√£o do Banco de Dados/Hist√≥rico) ---
if "df" not in st.session_state:
    st.session_state.df = None
if "rejeitados" not in st.session_state:
    st.session_state.rejeitados = []
# NOVA LISTA: Temporariamente armazena o look aprovado para for√ßar a variedade no pr√≥ximo clique
if "approved_temp_blacklist" not in st.session_state: 
    st.session_state.approved_temp_blacklist = []
if "cadastro_key" not in st.session_state:
    st.session_state.cadastro_key = 0 # Adiciona uma chave para for√ßar a limpeza do formul√°rio
if "feedback_status" not in st.session_state:
    st.session_state.feedback_status = None # Mensagens de sucesso/erro unificadas
# NOVO: Vari√°vel para controlar se o bot√£o de feedback foi clicado
if "feedback_submitted" not in st.session_state:
    st.session_state.feedback_submitted = False


# --- Fun√ß√µes de L√≥gica ---

def gerar_look():
    """Chama o motor de IA e aplica o filtro de rejei√ß√£o."""
    if st.session_state.df is None:
        st.error("Por favor, carregue um invent√°rio CSV primeiro.")
        return None
        
    looks = recomendar_looks(st.session_state.df.copy())
    
    # Prepara a lista total de looks a serem exclu√≠dos (rejeitados + aprovado tempor√°rio)
    looks_to_filter = st.session_state.rejeitados + st.session_state.approved_temp_blacklist

    # Aplica o filtro R5 do feedback: ignora looks rejeitados na sess√£o E looks aprovados recentemente
    if looks_to_filter:
        looks = looks[~looks.apply(lambda x: tuple(sorted([x['Pe√ßa 1'], x['Pe√ßa 2']])) in looks_to_filter, axis=1)]

    if not looks.empty:
        return looks.iloc[0]
    else:
        return None

# FUN√á√ÉO CADASTRAR PE√áA ATUALIZADA
def cadastrar_peca(tipo, cor, estilo, imagem_data_url=None):
    """Simula o Ciclo 1: Adiciona uma nova pe√ßa ao DataFrame, usando Data URL se houver upload."""
    novo_id = f"P{len(st.session_state.df) + 1}"
    
    # Define o link da imagem: usa a URL Base64 da imagem se fornecida, caso contr√°rio usa o placeholder padr√£o.
    image_link_to_save = imagem_data_url if imagem_data_url else f"https://placehold.co/150x150/1d4ed8/ffffff?text={tipo.replace(' ', '+')}"
    
    nova_peca = pd.DataFrame({
        'ID_PECA': [novo_id], 
        'TIPO': [tipo], 
        'COR': [cor], 
        'ESTILO': [estilo], 
        'STATUS_USO': [0],
        'IMAGEM_LINK': [image_link_to_save] # Usa o link/data URL gerado
    })
    
    st.session_state.df = pd.concat([st.session_state.df, nova_peca], ignore_index=True)
    
    # --- NOVIDADE: Feedback na Tela ---
    st.session_state.feedback_status = f"Pe√ßa '{tipo} {cor}' cadastrada com sucesso! (ID: {novo_id})"
    
    # Reinicia o formul√°rio
    st.session_state.cadastro_key += 1
    
    # For√ßa a atualiza√ß√£o da p√°gina inteira para recarregar o contador da sidebar
    st.rerun() 

# NOVA FUN√á√ÉO: ATUALIZAR IMAGEM DE PE√áA EXISTENTE
def atualizar_peca_imagem(peca_id, imagem_data_url):
    """Atualiza o link de imagem (Data URL) de uma pe√ßa existente."""
    if st.session_state.df is not None and peca_id in st.session_state.df['ID_PECA'].values:
        st.session_state.df.loc[st.session_state.df['ID_PECA'] == peca_id, 'IMAGEM_LINK'] = imagem_data_url
        st.session_state.feedback_status = f"Imagem da pe√ßa {peca_id} atualizada com sucesso!"
        st.rerun()
    else:
        st.session_state.feedback_status = f"Erro: Pe√ßa {peca_id} n√£o encontrada."


# --- Fluxo Principal do Aplicativo (Layout) ---

# 1. Carregamento do Invent√°rio (Vis√≠vel em ambas as abas)
uploaded_file = st.sidebar.file_uploader(
    "1. Carregar Invent√°rio (CSV)",
    type="csv",
    help="Carregue o arquivo inventario.csv para iniciar o sistema."
)

if uploaded_file and st.session_state.df is None:
    st.session_state.df = pd.read_csv(uploaded_file)
    st.sidebar.success(f"{len(st.session_state.df)} pe√ßas carregadas!")

# Se o invent√°rio estiver carregado, mostra os detalhes na barra lateral
if st.session_state.df is not None:
    st.sidebar.markdown(f"**Invent√°rio Atual:** {len(st.session_state.df)} Pe√ßas")
    with st.sidebar.expander("Ver Detalhes do Invent√°rio"):
        # Mostra o ID, TIPO e se a IMAGEM_LINK est√° preenchida (para visualiza√ß√£o do progresso)
        df_display = st.session_state.df[['ID_PECA', 'TIPO', 'COR', 'STATUS_USO', 'IMAGEM_LINK']].copy()
        df_display['IMAGEM_LINK'] = df_display['IMAGEM_LINK'].apply(lambda x: 'SIM' if (x and 'data:image' in x) else 'N√ÉO')
        st.dataframe(df_display, use_container_width=True)

# Define as abas
tab1, tab2 = st.tabs(["2. üëó Recomendar Look", "3. üìù Cadastro de Pe√ßas (Simula√ß√£o IA)"])

# --- TABELA 1: RECOMENDA√á√ÉO DE LOOK (FLUXOGRAMA CICLO 2) ---
with tab1:
    st.header("Seu Estilo, Nossas Regras")
    
    # Exibir feedback de sucesso/rejei√ß√£o
    if st.session_state.feedback_status:
        if "aprovado" in st.session_state.feedback_status.lower() or "registrado" in st.session_state.feedback_status.lower():
            st.success(st.session_state.feedback_status)
        elif "rejei√ß√£o" in st.session_state.feedback_status.lower():
            st.warning(st.session_state.feedback_status)
        # Limpa o status para que n√£o apare√ßa no pr√≥ximo clique
        st.session_state.feedback_status = None


    if st.session_state.df is None:
        st.warning("Por favor, carregue o invent√°rio na barra lateral para come√ßar.")
    else:
        # CORRE√á√ÉO CR√çTICA: Se o usu√°rio clicar no bot√£o, limpamos a blacklist tempor√°ria de aprovados
        if st.button("‚ú® Gerar Look Ideal", type="primary"):
            # 1. Limpa a blacklist tempor√°ria para permitir que o look aprovado volte
            st.session_state.approved_temp_blacklist = [] 
            # 2. Gera o look
            st.session_state.melhor_look = gerar_look()
            # 3. Garante que o feedback seja processado apenas PELO BOT√ÉO
            st.session_state.feedback_submitted = False 


        if "melhor_look" in st.session_state and st.session_state.melhor_look is not None:
            melhor_look = st.session_state.melhor_look

            st.subheader("‚úÖ Look Recomendado pela IA")
            st.markdown(f"**Score de Combina√ß√£o:** `{melhor_look['Score']}`")
            
            # Recupera as informa√ß√µes das pe√ßas
            peca1_id = melhor_look['Pe√ßa 1']
            peca2_id = melhor_look['Pe√ßa 2']
            
            # Usa placeholder para imagens n√£o encontradas
            placeholder = "https://placehold.co/150x150/cccccc/333333?text=N/D"

            peca1_data = st.session_state.df[st.session_state.df['ID_PECA'] == peca1_id].iloc[0]
            peca2_data = st.session_state.df[st.session_state.df['ID_PECA'] == peca2_id].iloc[0]

            col1, col2 = st.columns(2)
            with col1:
                st.image(peca1_data.get('IMAGEM_LINK', placeholder), 
                         caption=f"{peca1_data['TIPO']} ({peca1_data['COR']})", width=250)
            with col2:
                st.image(peca2_data.get('IMAGEM_LINK', placeholder), 
                         caption=f"{peca2_data['TIPO']} ({peca2_data['COR']})", width=250)

            # Justificativa da IA (Demonstra√ß√£o da l√≥gica)
            st.markdown("---")
            st.markdown("##### Justificativa da IA (Regras Aplicadas):")
            st.info("Esta combina√ß√£o obteve alta pontua√ß√£o por atender √†s **Regras R1 (Seguran√ßa: Neutro + Colorido)** e **R2 (Consist√™ncia de Estilo)**.")


            # --- Feedback Loop (Aprender com o Usu√°rio) ---
            st.subheader("üîÅ Feedback da Combina√ß√£o")
            
            # O r√°dio apenas define a escolha, mas n√£o aciona o fluxo
            feedback = st.radio("Voc√™ aprova este look?", ["Aprovar üòç", "Rejeitar üòê"], key='feedback_radio')
            
            # Novo: O bloco de feedback agora s√≥ √© processado ap√≥s o clique no bot√£o
            if st.button("Registrar Feedback e Continuar"):
                
                # Seta a vari√°vel de controle
                st.session_state.feedback_submitted = True
                
                # A l√≥gica agora est√° aqui dentro
                current_look_tuple = tuple(sorted([peca1_id, peca2_id]))

                if feedback == "Aprovar üòç":
                    # MANT√âM: Ajusta STATUS_USO para baixo quando aprovado
                    st.session_state.df.loc[st.session_state.df['ID_PECA'].isin([peca1_id, peca2_id]), 'STATUS_USO'] -= 1
                    
                    # 1. Feedback de Sucesso
                    st.session_state.feedback_status = "Aprovado! Look salvo no hist√≥rico. Pontua√ß√£o das pe√ßas ajustada."
                    
                    # 2. Adiciona √† blacklist tempor√°ria para for√ßar a variedade no pr√≥ximo clique
                    st.session_state.approved_temp_blacklist.append(current_look_tuple)

                    # 3. Reset da Interface
                    if 'melhor_look' in st.session_state:
                         del st.session_state.melhor_look # Remove o look da mem√≥ria

                    # 4. For√ßa o recarregamento para limpar a tela
                    st.rerun() 

                else: # Rejeitar üòê
                    # 1. Penaliza STATUS_USO (Regra R5)
                    st.session_state.df.loc[st.session_state.df['ID_PECA'].isin([peca1_id, peca2_id]), 'STATUS_USO'] += 2
                    
                    # 2. Marca look como rejeitado para n√£o ser sugerido NOVAMENTE nesta sess√£o
                    st.session_state.rejeitados.append(current_look_tuple)
                    
                    # --- CORRE√á√ÉO: Remove o look antigo da mem√≥ria ---
                    if 'melhor_look' in st.session_state:
                         del st.session_state.melhor_look
                    # --- FIM DA CORRE√á√ÉO ---

                    # 3. Tenta gerar um novo look Imediatamente
                    st.session_state.melhor_look = gerar_look()
                    
                    if st.session_state.melhor_look is None:
                        st.session_state.feedback_status = "Nenhum look v√°lido dispon√≠vel ap√≥s os feedbacks."
                    else:
                        # Limpa o feedback_status para evitar que a mensagem de sucesso da aba de aprova√ß√£o apare√ßa aqui
                        st.session_state.feedback_status = None 
                        st.session_state.feedback_status = "Rejei√ß√£o registrada! A IA est√° buscando o pr√≥ximo melhor look..." # Esta mensagem aparece no pr√≥ximo rerun

                    # 4. For√ßa o recarregamento para exibir a nova sugest√£o imediatamente
                    st.rerun()

# --- TABELA 2: CADASTRO DE PE√áAS (FLUXOGRAMA CICLO 1 SIMULADO) ---
with tab2:
    st.header("Cadastro e Gerenciamento de Pe√ßas")
    
    # Exibe a mensagem de feedback unificada
    if st.session_state.feedback_status:
        if "sucesso" in st.session_state.feedback_status.lower() or "registrado" in st.session_state.feedback_status.lower():
            st.success(st.session_state.feedback_status)
        elif "erro" in st.session_state.feedback_status.lower():
            st.error(st.session_state.feedback_status)
        # Limpa o status ap√≥s exibir (Ser√° limpo ap√≥s o st.rerun se n√£o houver um novo status)
        # Manter st.session_state.feedback_status = None apenas para o caso de aprova√ß√£o no tab2

    if st.session_state.df is None:
        st.warning("Carregue o invent√°rio na barra lateral para habilitar o cadastro.")
    else:
        # --- SUB-SE√á√ÉO 1: CADASTRAR NOVA PE√áA ---
        st.subheader("1. Cadastrar Nova Pe√ßa")
        st.markdown("**(Simula√ß√£o da IA)** Use esta se√ß√£o para simular o cadastro de uma pe√ßa nova, com classifica√ß√£o autom√°tica.")
        
        with st.form(key=f"form_cadastro_peca_{st.session_state.cadastro_key}"): 
            colA, colB = st.columns(2)
            
            uploaded_file_obj = None
            
            with colA:
                st.caption("Simula√ß√£o da Classifica√ß√£o da Imagem:")
                uploaded_file_obj = st.file_uploader("Upload da Foto (Input):", type=['jpg', 'png'], key=f"uploader_{st.session_state.cadastro_key}") 
                
                # Campos de sele√ß√£o (O resultado que a IA real retornaria)
                novo_tipo = st.selectbox("1. Tipo de Pe√ßa:", options=['Cal√ßa', 'Camiseta', 'Blazer', 'Saia', 'Casaco', 'Vestido', 'T√™nis'], index=0, key=f"tipo_{st.session_state.cadastro_key}")
            
            with colB:
                st.caption("Atributos Retornados:")
                # Baseado nos grupos da sua Regra IF/THEN
                nova_cor = st.selectbox("2. Cor (Classifica√ß√£o IA):", options=['Neutro', 'Prim√°ria', 'Estampada'], index=0, key=f"cor_{st.session_state.cadastro_key}")
                novo_estilo = st.selectbox("3. Estilo (Classifica√ß√£o IA):", options=['Casual', 'Formal', 'B√°sica', 'Jeans'], index=0, key=f"estilo_{st.session_state.cadastro_key}")
                
            submitted = st.form_submit_button("‚ûï Cadastrar Nova Pe√ßa (Salvar no DB)", type="primary")

            if submitted:
                imagem_data_url = None
                if uploaded_file_obj is not None:
                    try:
                        bytes_data = uploaded_file_obj.getvalue()
                        base64_encoded_data = base64.b64encode(bytes_data).decode()
                        mime_type = uploaded_file_obj.type
                        imagem_data_url = f"data:{mime_type};base64,{base64_encoded_data}"
                    except Exception as e:
                        st.session_state.feedback_status = f"Erro ao processar a imagem: {e}"
                
                if st.session_state.feedback_status is None or "Erro" not in st.session_state.feedback_status:
                    cadastrar_peca(novo_tipo, nova_cor, novo_estilo, imagem_data_url)
                    # st.rerun() chamado dentro de cadastrar_peca
        
        # --- SUB-SE√á√ÉO 2: ATUALIZAR IMAGEM DE PE√áA EXISTENTE (A SOLU√á√ÉO PARA A SUA PERGUNTA) ---
        st.markdown("---")
        st.subheader("2. Atualizar Imagem de Pe√ßa Existente")
        st.markdown("Use esta se√ß√£o para adicionar fotos √†s pe√ßas que voc√™ carregou no CSV, como P01, P02, etc.")

        with st.form(key=f"form_atualizar_peca"):
            peca_ids = st.session_state.df['ID_PECA'].tolist()
            
            colC, colD = st.columns(2)

            with colC:
                peca_selecionada = st.selectbox(
                    "Selecione o ID da Pe√ßa para Atualizar:", 
                    options=peca_ids,
                    index=0,
                    key="peca_selecionada_update"
                )

            with colD:
                uploaded_update_file_obj = st.file_uploader(
                    "Upload da Nova Foto:", 
                    type=['jpg', 'png'], 
                    key="uploader_update_img"
                )

            submitted_update = st.form_submit_button("üñºÔ∏è Aplicar Nova Imagem", type="secondary")

            if submitted_update:
                if uploaded_update_file_obj is not None:
                    try:
                        bytes_data = uploaded_update_file_obj.getvalue()
                        base64_encoded_data = base64.b64encode(bytes_data).decode()
                        mime_type = uploaded_update_file_obj.type
                        imagem_data_url = f"data:{mime_type};base64,{base64_encoded_data}"
                        
                        atualizar_peca_imagem(peca_selecionada, imagem_data_url)
                        # st.rerun() chamado dentro de atualizar_peca_imagem
                    except Exception as e:
                        st.session_state.feedback_status = f"Erro ao processar a imagem: {e}"
                else:
                    st.session_state.feedback_status = "Por favor, fa√ßa o upload de uma imagem."
                    st.rerun() # Para exibir a mensagem de erro/aviso imediatamente
